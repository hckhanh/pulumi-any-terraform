$schema: './cache/schemas/tasks.json'

fileGroups:
  sources:
    - 'package.json'
    - '**/*.{ts,js,mjs,cjs}'
  build:
    - 'bin/**/*'
  package:
    - 'README.md'
  eslint:
    - '**/*.{ts,md}'

tasks:
  eslint:
    command: 'pnpm eslint .'
    inputs:
      - '@group(eslint)'
  eslint.fix:
    extends: 'eslint'
    args: '--fix'
  lint:
    deps:
      - target: 'eslint'
      - target: 'root:syncpack.lint'
        args: '--source $projectSource/package.json'
      - target: 'root:syncpack.format.check'
        args: '--source $projectSource/package.json'
  fix:
    deps:
      - target: 'eslint.fix'
      - target: 'root:syncpack.fix'
        args: '--source $projectSource/package.json'
      - target: 'root:syncpack.format'
        args: '--source $projectSource/package.json'
    options:
      runDepsInParallel: false
  audit:
    command: 'npm audit signature --no-package-lock'
    inputs:
      - '@group(sources)'
  build:
    command: 'pnpm tsdown'
    inputs:
      - '@group(sources)'
    outputs:
      - 'bin/**/*'
  publish:
    command: 'pnpm publish --provenance --access public'
    inputs:
      - '@group(sources)'
      - '@group(package)'
      - '$NPM_TOKEN'
    outputs:
      - '@group(build)'
    deps:
      - 'audit'
      - 'build'
    options:
      allowFailure: true
